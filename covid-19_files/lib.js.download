!function(){"use strict";const e={displayModes:{DESKTOP:0,MOBILE:1}},t={websocket:!1,client:{interval:5e3,targetUrl:"https://heatmap-events-collector.instapage.com",clientVersion:2,error:{timeout:1e4,maxOccurrence:3},trackers:{eventsList:["onclick","onmousemove","onscroll"],mouseMoveTimeout:80},windowProperties:{normalMobileWidth:400}}},i=window._debugMode;function o(e){const t=[],i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let o=0;o<e;o+=1)t.push(i.charAt(Math.floor(Math.random()*i.length)));return t.join("")}function n(e,t){let i;return(...o)=>{clearTimeout(i),i=setTimeout(()=>e(...o),t)}}function s(e){const{innerWidth:t,__page_generator:o,__config:n,__mobile_version:s}=e;if(o){const e=n&&n.mobileDisabled;return i&&console.log("isMobileMode PG:",!e&&t<768,t,768),!e&&t<768}return i&&console.log("isMobileMode",s&&t<768,t,768),s&&t<620}function r(e){return e.scrollY||e.document.scrollTop||e.document.body.scrollTop||0}class a{constructor(e){this.ajaxPath="/api/raw-data",this.websocketPath="/ws/raw-data",this.options=e,this.useBeacon=!1}getFullRESTPath(){return this.options.targetUrl+this.ajaxPath}sendByAjax(e){return fetch(this.getFullRESTPath(),{method:"POST",headers:{connection:"keep-alive"},body:JSON.stringify(e)}).then(e=>e.ok?Promise.resolve(e):Promise.reject(e))}sendByBeacon(e){if(navigator&&navigator.sendBeacon){const t=this.getFullRESTPath();try{return navigator.sendBeacon(t,JSON.stringify(e)),Promise.resolve()}catch(t){return this.sendByAjax(e)}}return this.sendByAjax(e)}send(e){return this.useBeacon?this.sendByBeacon(e):this.sendByAjax(e)}}class l{constructor(e){this.pixelRatio=1,this.isMobileModeOn=s(e.window),this.options=e,this.isPopupOpened=!1,this.popupId=!1,this.errorCount=0,this.sendTimestamp=0,this.enableSend=!0,this.request=new a(e),this.sentScrollDesktop=0,this.sentScrollMobile=0,this.currentMaxScrollDesktop=0,this.currentMaxScrollMobile=0,this.storage=[],this.singleSessionStorage={},this.resetStorage()}resetStorage(){this.singleSessionStorage.mousemove=[],this.singleSessionStorage.click=[]}wrapDataToSend(e){return{displayMode:this.displayMode,sessionId:this.options.sessionId,pageId:this.options.pageId,version:this.options.pageVersion,variation:this.options.pageVariation,variationHash:this.options.pageVariationHash,popupId:this.popupId,clientVersion:this.options.clientVersion,data:e}}checkForDisplayModeChange(){this.displayMode?(this.isMobileModeOn||this.addDataToStorage(),this.isMobileModeOn=!0):(this.isMobileModeOn&&this.addDataToStorage(),this.leftEdgeElement||this.findEdgeElements(),this.isMobileModeOn=!1)}isPointInBoundaries({x:e,y:t}){const{leftMargin:i,topMargin:o,width:n,height:s}=this;return i<e&&i+n>e&&o<t&&o+s>t}findEdgeElements(){const{innerSection:e,options:{isPageGenerator:t,window:{document:{body:i,body:{clientWidth:o}}}}}=this;let[n,s]=[o,0],r=[];r=t?i.getElementsByTagName("main").item(0).getElementsByClassName("widget"):i.getElementsByClassName("block-inner");for(let e=0;e<r.length;e++){const t=r.item(e),{left:i,right:o,width:a}=t.getBoundingClientRect();a&&n>i&&(n=i,this.leftEdgeElement=t),a&&s<o&&(s=o,this.rightEdgeElement=t)}if(r.length){const{left:t,right:i}=e.getBoundingClientRect();n>t&&(this.leftEdgeElement=e),s<i&&(this.rightEdgeElement=e)}else this.leftEdgeElement=e,this.rightEdgeElement=e;this.leftEdgeElement||(this.leftEdgeElement=e),this.rightEdgeElement||(this.rightEdgeElement=e),this.leftEdgeElement||(this.enableSend=!1)}findInnerSection(){const{isPageGenerator:e,window:{document:{body:t}}}=this.options,i=e?"section-inner":"block-inner",o=t.getElementsByClassName(i);for(let e=0;e<o.length;e++){const t=o.item(e);if(t.clientWidth)return void(this.innerSection=t)}this.innerSection||(this.enableSend=!1)}updateHeatmapDivBoundaries(){const{isPageGenerator:t,heatmapDiv:o,window:{innerWidth:n,scrollX:r,scrollY:a,document:{body:{offsetHeight:l}}}}=this.options;let d,h,c,p,g,u=0;if(this.displayMode=function(t){return e.displayModes[s(t)?"MOBILE":"DESKTOP"]}(window),this.checkForDisplayModeChange(),this.setMaxScroll(),this.isMobileModeOn){const{width:e,left:t}=this.innerSection.getBoundingClientRect();p=e,d=t,c=l}else d=this.leftEdgeElement.getBoundingClientRect().left,h=this.rightEdgeElement.getBoundingClientRect().right,c=l,p=h-d;if(this.isPopupOpened){const{left:e,right:t,height:i,width:o,top:n}=this.popupElement.getBoundingClientRect();d=e,u=n+a,h=t,c=i,p=o}if(d+=r,t)if(g=d,this.isMobileModeOn)this.pixelRatio=n<400?400/n:1;else{const{width:e}=this.innerSection.getBoundingClientRect();this.pixelRatio=960/e}else g=d>0?d:0;i&&console.log("Pixel ratio:",this.pixelRatio),this.leftMargin=g,this.topMargin=u,this.width=p,this.height=c,o.style.left=`${g}px`,o.style.width=`${p}px`,o.style.height=`${c}px`,o.style.top=`${u}px`}addPointToStorage(e,t,o){const{leftMargin:n,topMargin:s,pixelRatio:r,height:a,width:l}=this,d=t-n,h=o-s;d<0||h<0||d>l||h>a||!r||(i&&"click"===e&&(console.log("addPointToStorage:",d,h,n,s,l,a),console.log("with pixelRatio:",Math.round(d*r),Math.round(h*r))),this.singleSessionStorage[e].push({x:Math.round(d*r),y:Math.round(h*r)}))}setMaxScroll(){const{displayMode:e,currentMaxScrollMobile:t,currentMaxScrollDesktop:o,height:n,options:{window:s}}=this,a=Math.floor(r(s)+s.innerHeight),l=Math.floor(n),d=a>l?l:a;e&&t<d?this.currentMaxScrollMobile=d:!e&&o<d&&(this.currentMaxScrollDesktop=d),i&&console.log("setMaxScroll:::","displayMode:",e,"scroll:",d,"currentMaxScrollMobile",this.currentMaxScrollMobile,"currentMaxScrollDesktop",this.currentMaxScrollDesktop)}addDataToStorage(){const{currentMaxScrollMobile:e=0,currentMaxScrollDesktop:t=0,displayMode:i,sentScrollMobile:o,sentScrollDesktop:n,pixelRatio:s}=this,r=Math.floor((i?e:t)*s),a=i?o:n,l=[];if(this.singleSessionStorage.mousemove.length&&l.push({eventName:"mousemove",data:this.singleSessionStorage.mousemove}),this.singleSessionStorage.click.length&&l.push({eventName:"click",data:this.singleSessionStorage.click}),r&&a<r&&(l.push({eventName:"scroll",data:[{y:r}]}),i?this.sentScrollMobile=r:this.sentScrollDesktop=r),this.resetStorage(),l.length){const e=this.wrapDataToSend(l);this.storage.push(e)}}sendBeacon(){for(this.addDataToStorage();this.storage.length;){const e=this.storage.shift();this.request.send(e)}}sendData(){if(this.enableSend&&this.storage.length&&Date.now()>this.sendTimestamp){const e=this.storage.shift();this.request.send(e).then(()=>{this.errorCount=0}).catch(t=>{console.error(t);const{options:{error:i}}=this;this.errorCount+=1,this.errorCount<i.maxOccurrence?this.sendTimestamp=Date.now()+i.timeout:this.enableSend=!1,this.storage.push(e)})}}init(){this.isMobileModeOn=s(this.options.window),this.findInnerSection(),this.isMobileModeOn||this.findEdgeElements(),this.updateHeatmapDivBoundaries(),this.resetStorage(),this.setMaxScroll(),setInterval(()=>{this.addDataToStorage(),setTimeout(()=>{this.sendData()},this.options.interval/2)},this.options.interval)}}function d(){if(!window.__preview){const{__variant:a,__variant_hash:d,__version:h,__page_id:c,__page_generator:p,__workspaceWidth:g=960,__page_domain:u,location:{href:m}}=window;(!u||u&&-1===m.indexOf(u.replace("//","")))&&console.log("HEATMAP EVENTS COLLECTING BLOCKED");const{websocket:w,client:{targetUrl:M,interval:S,error:E,windowProperties:f,clientVersion:y,trackers:v}}=t;if(function(e,t){for(let i=0;i<t.length;i++)if(t[i]===e)return!0;return!1}(`${d}:${e.displayModes[s(window)?"DESKTOP":"MOBILE"]}`,window.__predator_blacklist))return;const b=document.createElement("div");i&&document.body.appendChild(b);const x={window:window,heatmapDiv:b,pageVariationHash:d,interval:S,error:E,pageId:c,pageVersion:h,targetUrl:M,windowProperties:f,workspaceWidth:g,trackers:v,isPageGenerator:p,clientVersion:p?3:y,pageVariation:a.split("-")[0],sessionId:o(12),websocket:"true"===w||!0===w},B=new l(x);window._htmp=B;const D=/iPhone|iPad/i.test(window.navigator.userAgent);let T=!1;const k=()=>{T||(B.request.useBeacon=!0,B.sendBeacon()),T=!0};i&&(b.setAttribute("id","heatmapDiv"),b.style.position="absolute",b.style.top="0px",b.style.left="0px",b.style.opacity=0,b.style.background="green",b.style.zIndex=1);const P=function(e,t){let i=0;return function(...o){const n=(new Date).getTime();if(!(n-i<e))return i=n,t(...o)}}(v.mouseMoveTimeout,B.addPointToStorage.bind(B)),_=({type:e,pageX:t,pageY:o,clientX:n,clientY:s})=>{const a=r(window),l=function(e){return e.scrollX||e.document.scrollLeft||e.document.body.scrollLeft||0}(window);let d,h;if(null==t||null==o){const{documentElement:{clientLeft:e,clientTop:t},body:{clientLeft:i,clientTop:o}}=document;d=n+l-(e||i||0),h=s+a-(t||o||0)}else d=t,h=o;B.isPointInBoundaries({x:d,y:h})&&("mousemove"!==e||B.isMobileModeOn&&D?"click"===e&&(B.addPointToStorage(e,d,h),i&&(console.log("mouse click event",d,h),console.log("SIZE:","heatmapDiv.width:",b.style.width,"window.outerWidth",window.outerWidth,"heatmapDiv.style.height",b.style.height,"window.outerHeight",window.outerHeight))):P(e,d,h))},O=()=>{B.isPopupOpened&&B.updateHeatmapDivBoundaries()};let I;const L=e=>{const t=e.detail,o=t.id||t.data.id,n=document.getElementById(`popup-${o}`);B.addDataToStorage();const s=p?n.getElementsByClassName("lightbox-content")[0]:n.getElementsByClassName("popup-inner")[0];B.popupId=o,B.isPopupOpened=!0,B.popupElement=s,i&&(b.style.zIndex=10500001),setTimeout(()=>{I=s.parentElement,I.addEventListener("scroll",O),B.updateHeatmapDivBoundaries()},500)},C=()=>{I.removeEventListener("scroll",O),B.addDataToStorage(),i&&(b.style.zIndex=1),B.popupId=!1,B.isPopupOpened=!1,setTimeout(()=>{B.updateHeatmapDivBoundaries()},p?1:200)},R=()=>{B.setMaxScroll()};B.init(document.body.firstElementChild),window.addEventListener("preview.popup.shown",e=>setTimeout(()=>L(e))),window.addEventListener("preview.popup.hide",e=>setTimeout(()=>C())),window.addEventListener("resize",n(B.updateHeatmapDivBoundaries.bind(B),350)),window.addEventListener("scroll",n(R.bind(this),100)),window.document.addEventListener("mousemove",_,!0),window.document.addEventListener("click",_,!0),i&&window.addEventListener("keyup",e=>{"h"===e.key?b.style.opacity=0:"s"===e.key&&(b.style.opacity=.3)}),window.addEventListener("beforeunload",k.bind(this)),window.addEventListener("unload",k.bind(this))}}"complete"===document.readyState||"loaded"===document.readyState?d():window.addEventListener?window.addEventListener("load",d):window.attachEvent?window.attachEvent("onreadystatechange",()=>{"complete"===document.readyState&&d()}):console.error("Unsupported browser")}();
